<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finanzas V42 - Independent</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 900: '#0c4a6e' },
                        slate: { 850: '#1a202c', 900: '#111827' }
                    },
                    animation: { 
                        'pop': 'pop 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards',
                        'slide-in': 'slideIn 0.4s ease-out forwards',
                        'pulse-red': 'pulseRed 2s infinite',
                        'success-scale': 'successScale 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards',
                        'vanish': 'vanish 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards'
                    },
                    keyframes: { 
                        pop: { '0%': { opacity: '0', transform: 'scale(0.96) translateY(10px)' }, '100%': { opacity: '1', transform: 'scale(1) translateY(0)' } },
                        slideIn: { '0%': { opacity: '0', transform: 'translateX(-10px)' }, '100%': { opacity: '1', transform: 'translateX(0)' } },
                        pulseRed: { '0%, 100%': { boxShadow: '0 0 0 0 rgba(244, 63, 94, 0.7)' }, '70%': { boxShadow: '0 0 0 10px rgba(244, 63, 94, 0)' } },
                        successScale: { '0%': { opacity: '0', transform: 'scale(0.5)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        vanish: { '0%': { opacity: '1', transform: 'scale(1)', filter: 'blur(0)' }, '100%': { opacity: '0', transform: 'scale(0.9)', filter: 'blur(10px)' } }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; color: #0f172a; -webkit-font-smoothing: antialiased; }
        
        /* --- CURSOR SYSTEM --- */
        html body * { cursor: default !important; }
        input[type="text"], input[type="number"], input[type="email"], textarea { cursor: text !important; }
        .section-header:active, .drag-handle:active { cursor: grabbing !important; }
        .cursor-pointer { cursor: pointer !important; }

        /* Layout Utils */
        .sidebar-drawer { transform: translateX(-100%); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 50; position: fixed; top: 0; left: 0; bottom: 0; width: 20rem; background: white; border-right: 1px solid #e2e8f0; }
        .sidebar-drawer.open { transform: translateX(0); }
        .backdrop { opacity: 0; pointer-events: none; transition: opacity 0.3s; background: rgba(15, 23, 42, 0.5); backdrop-filter: blur(4px); position: fixed; inset: 0; z-index: 40; }
        .backdrop.open { opacity: 1; pointer-events: auto; }
        
        /* Modals & Sheets */
        .modal-container { opacity: 0; pointer-events: none; transition: all 0.3s; z-index: 60; position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; padding: 1.5rem; }
        .modal-container.open { opacity: 1; pointer-events: auto; }
        .modal-content { transform: scale(0.95); transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .modal-container.open .modal-content { transform: scale(1); }
        
        .analytics-sheet { position: fixed; inset: 0; background: #fff; z-index: 70; transform: translateY(100%); transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1); display: flex; flex-direction: column; }
        .analytics-sheet.open { transform: translateY(0); }

        /* SUCCESS OVERLAY */
        .success-overlay { position: fixed; inset: 0; z-index: 80; display: flex; align-items: center; justify-content: center; pointer-events: none; opacity: 0; transition: opacity 0.3s; }
        .success-overlay.show { opacity: 1; pointer-events: auto; }
        .success-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 2rem; border-radius: 2rem; box-shadow: 0 20px 50px -10px rgba(0,0,0,0.15); text-align: center; transform: scale(0.8); transition: transform 0.3s; border: 1px solid #e2e8f0; }
        .success-overlay.show .success-card { animation: successScale 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        /* Inputs & UI */
        .input-pro { border: 2px solid #e2e8f0; background: #fff; border-radius: 0.75rem; color: #1e293b; font-weight: 700; transition: all 0.2s; }
        .input-pro:focus { border-color: #0ea5e9; outline: none; box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.1); }
        .card-premium { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); border: 1px solid #f1f5f9; }
        .bg-savings-gradient { background: linear-gradient(135deg, #0f172a 0%, #334155 100%); color: white; }
        
        /* Animaciones UI */
        .btn-anim { transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); display: inline-flex; align-items: center; justify-content: center; } 
        .btn-anim:active { transform: scale(0.95); }
        
        /* Accordion */
        .accordion-content { transition: max-height 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.3s; overflow: hidden; max-height: 3000px; opacity: 1; }
        .accordion-content.collapsed { max-height: 0; opacity: 0; }
        .rotate-icon { transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .rotate-icon.collapsed { transform: rotate(-90deg); }

        /* Coach Pro */
        .coach-tip-item { display: flex; gap: 1rem; margin-bottom: 1rem; align-items: flex-start; animation: slideIn 0.5s ease-out; padding: 12px; background: rgba(255,255,255,0.05); border-radius: 12px; }
        .coach-icon { color: #facc15; font-size: 1.2rem; flex-shrink: 0; margin-top: 2px; }
        .coach-text strong { color: #fff; display: block; margin-bottom: 2px; font-size: 0.9rem;}
        .coach-text { color: #94a3b8; font-size: 0.85rem; line-height: 1.4; }
        .health-bar-bg { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 99px; overflow: hidden; margin-top: 8px;}
        .health-bar-fill { height: 100%; border-radius: 99px; transition: width 1s ease-out; }

        /* Masonry & Sortable Helpers */
        .masonry-col { display: flex; flex-direction: column; gap: 1.5rem; min-height: 200px; transition: background 0.3s; border-radius: 1rem; }
        body.edit-mode .masonry-col { background: rgba(241, 245, 249, 0.5); border: 2px dashed #e2e8f0; }
        
        .vanish-effect { animation: vanish 0.6s forwards; pointer-events: none; }
        .sortable-ghost { opacity: 0.3; background: #f1f5f9; border: 2px dashed #cbd5e1; transform: scale(0.98); }
        
        .btn-delete-item { opacity: 0; transition: opacity 0.2s; pointer-events: none; }
        body.edit-mode .btn-delete-item { opacity: 1; pointer-events: auto; cursor: pointer !important; }
        .section-delete-btn { display: none; }
        body.edit-mode .section-delete-btn { display: flex; cursor: pointer !important; }
        
        .month-badge { font-size: 10px; background: #f1f5f9; padding: 2px 6px; border-radius: 4px; color: #64748b; font-weight: 700; text-transform: uppercase; margin-left: 8px; }
    </style>
</head>
<body class="h-[100dvh] flex overflow-hidden bg-[#f8fafc]">

    <div id="main-backdrop" class="backdrop" onclick="closeAll()"></div>

    <div id="success-overlay" class="success-overlay">
        <div class="success-card">
            <div class="w-20 h-20 rounded-full bg-emerald-100 flex items-center justify-center mx-auto mb-4 text-emerald-500">
                <i class="ph-fill ph-check-circle text-5xl"></i>
            </div>
            <h3 class="text-xl font-extrabold text-slate-900">¬°Mes Limpio!</h3>
            <p class="text-slate-500 text-sm font-medium mt-1">Todo ha quedado en blanco.</p>
        </div>
    </div>

    <aside id="drawer" class="sidebar-drawer flex flex-col shadow-2xl">
        <div class="h-24 flex items-center px-6 border-b border-slate-100 justify-between bg-white">
            <h1 class="font-extrabold text-2xl tracking-tight text-slate-900">CFO<span class="text-brand-600">.</span>Panel</h1>
            <button onclick="closeAll()" class="text-slate-400 hover:text-slate-800 p-2 bg-slate-100 rounded-lg btn-anim cursor-pointer"><i class="ph-bold ph-x text-xl"></i></button>
        </div>
        <nav id="month-nav-container" class="flex-1 overflow-y-auto px-6 py-8 space-y-2 custom-scrollbar bg-slate-50/50"></nav>
        <div class="p-6 border-t border-slate-100 bg-white">
            <button onclick="openCloneModal()" class="w-full mb-3 py-3.5 bg-white border-2 border-slate-200 text-slate-700 rounded-xl text-xs font-bold flex items-center justify-center gap-2 hover:border-brand-500 hover:text-brand-600 transition-all btn-anim cursor-pointer"><i class="ph-bold ph-copy text-lg"></i> Duplicar Mes</button>
            <button onclick="openSettings()" class="w-full py-3.5 bg-slate-900 text-white rounded-xl text-xs font-bold flex items-center justify-center gap-2 hover:bg-black transition-all btn-anim cursor-pointer"><i class="ph-bold ph-gear text-lg"></i> Ajustes</button>
        </div>
    </aside>

    <div id="analytics-overlay" class="analytics-sheet">
        <div class="h-20 flex items-center justify-between px-6 border-b border-slate-100 bg-white">
            <h2 class="text-xl font-extrabold text-slate-900 flex items-center gap-2"><i class="ph-fill ph-chart-polar text-brand-600"></i> Sala de Juntas</h2>
            <div class="flex items-center gap-3">
                <button onclick="closeAnalytics()" class="w-10 h-10 rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 btn-anim cursor-pointer"><i class="ph-bold ph-x text-xl"></i></button>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto p-6 bg-[#f8fafc] custom-scrollbar">
            <div class="max-w-6xl mx-auto space-y-8 animate-pop">
                <div class="bg-white p-6 rounded-3xl card-premium">
                    <h3 class="font-bold text-slate-800 mb-4">Tendencia Anual</h3>
                    <div class="h-80"><canvas id="trendChart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-3xl card-premium">
                    <h3 class="font-bold text-slate-800 mb-4">Top Categor√≠as</h3>
                    <div class="h-64"><canvas id="categoryChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <div id="clone-modal" class="modal-container">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md relative z-10 p-8 modal-content border border-slate-100">
            <h3 class="font-bold text-2xl mb-2 text-slate-800">Duplicar Mes</h3>
            <div class="relative mb-6">
                <select id="target-month-select" class="w-full appearance-none bg-slate-50 border-2 border-slate-200 text-slate-800 font-bold py-4 px-5 rounded-2xl focus:outline-none focus:border-brand-500 transition-all cursor-pointer"></select>
                <div class="absolute right-5 top-1/2 -translate-y-1/2 text-slate-500 pointer-events-none"><i class="ph-bold ph-caret-down text-xl"></i></div>
            </div>
            <div class="flex gap-3">
                <button onclick="closeAll()" class="flex-1 py-3.5 rounded-xl font-bold text-sm text-slate-500 bg-slate-100 hover:bg-slate-200 btn-anim cursor-pointer">Cancelar</button>
                <button onclick="executeClone()" class="flex-1 py-3.5 bg-brand-600 text-white rounded-xl font-bold text-sm hover:bg-brand-700 shadow-lg shadow-brand-500/20 btn-anim cursor-pointer">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="delete-modal" class="modal-container">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-sm relative z-10 p-8 modal-content border border-rose-100 text-center">
            <div class="w-16 h-16 rounded-full bg-rose-100 text-rose-500 flex items-center justify-center mx-auto mb-4 animate-pulse-red">
                <i class="ph-fill ph-warning text-3xl"></i>
            </div>
            <h3 class="font-extrabold text-2xl mb-2 text-slate-900">¬øBorrar Mes?</h3>
            <p class="text-sm text-slate-500 font-medium mb-8 leading-relaxed">
                Se eliminar√°n todos los registros de <span id="delete-month-name" class="font-bold text-slate-800">Enero</span>. No podr√°s deshacerlo.
            </p>
            <div class="flex gap-3">
                <button onclick="closeAll()" class="flex-1 py-3.5 rounded-xl font-bold text-sm text-slate-600 bg-slate-100 hover:bg-slate-200 btn-anim cursor-pointer">Cancelar</button>
                <button onclick="executeDelete()" class="flex-1 py-3.5 bg-rose-500 text-white rounded-xl font-bold text-sm hover:bg-rose-600 shadow-lg shadow-rose-500/30 btn-anim cursor-pointer">S√≠, Limpiar</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal-container">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-md relative z-10 overflow-hidden modal-content border border-slate-100">
            <div class="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                <h3 class="font-bold text-lg text-slate-800 flex items-center gap-2"><i class="ph-fill ph-gear text-slate-500"></i> Herramientas</h3>
                <button onclick="closeAll()" class="text-slate-400 hover:text-slate-800 btn-anim cursor-pointer"><i class="ph-bold ph-x text-xl"></i></button>
            </div>
            <div class="p-6 space-y-4">
                <button onclick="exportExcel('current')" class="w-full py-3 bg-emerald-50 text-emerald-700 font-bold rounded-xl btn-anim cursor-pointer">Exportar CSV</button>
                <button onclick="resetAll()" class="w-full py-3 text-xs font-bold text-slate-400 hover:text-slate-600 rounded-xl transition-all btn-anim cursor-pointer">Reiniciar Todo (F√°brica)</button>
            </div>
        </div>
    </div>

    <main class="flex-1 flex flex-col h-full relative w-full overflow-hidden">
        
        <header class="h-24 flex items-center justify-between px-6 md:px-12 z-10 sticky top-0 bg-[#f8fafc]/90 backdrop-blur-md transition-all border-b border-slate-200">
            <div class="flex items-center gap-5">
                <button onclick="openMenu()" class="p-3 -ml-2 text-slate-600 hover:text-slate-900 hover:bg-white hover:shadow-sm rounded-xl transition-all btn-anim cursor-pointer"><i class="ph-bold ph-list text-3xl"></i></button>
                <div>
                    <div class="flex items-center gap-3">
                        <h2 id="current-month-display" class="text-3xl font-extrabold text-slate-900 tracking-tight animate-pop">Enero</h2>
                        <button onclick="openDeleteModal()" class="w-8 h-8 rounded-full bg-rose-50 text-rose-400 hover:bg-rose-100 hover:text-rose-600 flex items-center justify-center transition-all btn-anim cursor-pointer" title="Borrar este mes">
                            <i class="ph-bold ph-trash text-lg"></i>
                        </button>
                    </div>
                    <div id="sync-status" class="flex items-center gap-2 mt-1 opacity-0 transition-opacity duration-500">
                        <div class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.6)]"></div>
                        <span class="text-[11px] font-bold text-slate-500 uppercase tracking-wider" id="sync-text">Conectando...</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="openAnalytics()" class="w-11 h-11 rounded-xl bg-brand-50 border-2 border-brand-200 text-brand-600 hover:bg-brand-100 flex items-center justify-center transition-all shadow-sm btn-anim cursor-pointer" title="Sala de Juntas"><i class="ph-fill ph-chart-line-up text-xl"></i></button>
                <button onclick="toggleGlobalCollapse()" class="w-11 h-11 rounded-xl bg-white border-2 border-slate-200 text-slate-400 hover:text-slate-800 hover:border-slate-400 flex items-center justify-center transition-all shadow-sm btn-anim cursor-pointer" title="Expandir/Contraer">
                    <i class="ph-bold ph-arrows-out-line-vertical text-xl" id="global-collapse-icon"></i>
                </button>
                <div class="flex bg-white p-1.5 rounded-xl border-2 border-slate-200 shadow-sm ml-2">
                    <button onclick="setMode('view')" id="btn-view" class="px-5 py-2 text-xs font-bold rounded-lg bg-slate-900 text-white shadow transition-all btn-anim cursor-pointer">Ver</button>
                    <button onclick="setMode('edit')" id="btn-edit" class="px-5 py-2 text-xs font-bold rounded-lg text-slate-500 hover:text-slate-900 transition-all btn-anim cursor-pointer">Editar</button>
                </div>
            </div>
        </header>

        <div id="dashboard-content" class="flex-1 overflow-y-auto p-4 md:p-8 custom-scrollbar">
            <div class="max-w-7xl mx-auto pb-32 animate-pop">
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white p-7 rounded-3xl card-premium flex flex-col justify-between h-36 border-l-8 border-slate-800">
                        <p class="text-slate-500 text-[11px] font-extrabold uppercase tracking-widest">Disponible</p>
                        <h3 class="text-4xl font-extrabold text-slate-900 tracking-tight" id="kpi-balance">S/ 0,00</h3>
                    </div>
                    <div class="bg-white p-7 rounded-3xl card-premium flex flex-col justify-between h-36 border-l-8 border-emerald-500">
                        <p class="text-slate-500 text-[11px] font-extrabold uppercase tracking-widest">Ingresos</p>
                        <h3 class="text-3xl font-extrabold text-emerald-600 tracking-tight" id="kpi-income">S/ 0,00</h3>
                    </div>
                    <div class="bg-white p-7 rounded-3xl card-premium flex flex-col justify-between h-36 border-l-8 border-orange-500">
                        <p class="text-slate-500 text-[11px] font-extrabold uppercase tracking-widest">Gastos</p>
                        <h3 class="text-3xl font-extrabold text-orange-600 tracking-tight" id="kpi-expenses">S/ 0,00</h3>
                    </div>
                    <div class="bg-savings-gradient p-7 rounded-3xl shadow-xl flex flex-col justify-between h-36 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-6 opacity-20 group-hover:scale-110 transition-transform duration-700"><i class="ph-fill ph-piggy-bank text-9xl"></i></div>
                        <div class="flex justify-between items-center relative z-10">
                            <p class="text-slate-300 text-[11px] font-extrabold uppercase tracking-widest">Ahorro</p>
                            <span id="kpi-rate" class="text-[11px] bg-white/20 px-2 py-1 rounded-md backdrop-blur-md font-bold text-white">0%</span>
                        </div>
                        <h3 class="text-3xl font-extrabold text-white tracking-tight relative z-10" id="kpi-savings">S/ 0,00</h3>
                    </div>
                </div>

                <div class="h-px bg-slate-200 w-full my-10"></div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8" id="charts-container">
                    <div class="bg-white p-8 rounded-3xl card-premium h-96 relative flex flex-col items-center justify-center border-2 border-slate-100">
                        <h4 class="absolute top-6 left-6 text-slate-500 font-extrabold text-xs uppercase tracking-widest">Distribuci√≥n</h4>
                        <div class="w-full h-full relative"><canvas id="expenseChart"></canvas></div>
                        <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none mt-4">
                            <span class="text-[11px] text-slate-400 font-extrabold uppercase mb-1">Total Salidas</span>
                            <span class="text-3xl font-extrabold text-slate-900 tracking-tight" id="center-total">S/ 0,00</span>
                        </div>
                    </div>
                    <div class="bg-white p-8 rounded-3xl card-premium h-96 col-span-2 flex flex-col justify-end border-2 border-slate-100">
                        <h4 class="mb-6 text-slate-500 font-extrabold text-xs uppercase tracking-widest">Flujo Mensual</h4>
                        <div class="flex-1 w-full"><canvas id="flowChart"></canvas></div>
                    </div>
                </div>

                <div class="h-px bg-slate-200 w-full my-10"></div>

                <div class="bg-slate-900 rounded-3xl p-8 text-white relative overflow-hidden shadow-2xl">
                    <div class="absolute top-0 right-0 p-6 opacity-10"><i class="ph-fill ph-brain text-9xl"></i></div>
                    <div class="relative z-10">
                        <div class="flex items-center justify-between mb-6">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-brand-500 flex items-center justify-center"><i class="ph-bold ph-strategy text-xl"></i></div>
                                <div>
                                    <h3 class="font-bold text-lg">Reporte CFO</h3>
                                    <p class="text-xs text-slate-400">An√°lisis Profesional</p>
                                </div>
                            </div>
                            <button onclick="refreshAnalysis()" class="px-5 py-2 bg-white text-slate-900 rounded-xl text-xs font-bold flex items-center gap-2 hover:scale-105 transition-transform btn-anim cursor-pointer"><i class="ph-bold ph-lightning"></i> Generar Reporte</button>
                        </div>
                        
                        <div class="flex flex-col md:flex-row gap-8">
                            <div class="w-full md:w-1/4 border-r border-white/10 pr-6">
                                <p class="text-[11px] text-slate-400 uppercase font-bold tracking-widest mb-1">Salud Financiera</p>
                                <div class="flex items-end gap-2 mb-2">
                                    <span id="health-score" class="text-5xl font-extrabold text-white tracking-tighter">--</span>
                                    <span class="text-sm text-slate-400 font-medium mb-1">/ 100</span>
                                </div>
                                <div class="health-bar-bg"><div id="health-bar" class="health-bar-fill bg-slate-600" style="width: 0%"></div></div>
                                <p id="advisor-status" class="mt-3 text-sm font-bold text-slate-300">Sin Datos</p>
                            </div>
                            <div class="w-full md:w-3/4 pl-0 md:pl-4">
                                <p class="text-[11px] text-slate-400 uppercase font-bold tracking-widest mb-4">Estrategia del Mes</p>
                                <div id="advisor-tips" class="hidden space-y-1"></div>
                                <div id="advisor-placeholder" class="text-sm text-slate-500 italic flex items-center gap-2">
                                    <i class="ph-bold ph-info"></i> Registra ingresos y gastos para activar la IA.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="h-px bg-slate-200 w-full my-10"></div>

                <div class="flex items-center gap-4 mb-6">
                    <h3 class="text-lg font-extrabold text-slate-900 flex items-center gap-2"><i class="ph-fill ph-list-dashes text-slate-400"></i> Desglose de Operaciones <span class="month-badge" id="breakdown-month-badge">ENERO</span></h3>
                </div>

                <div class="flex flex-col sm:flex-row gap-6 items-start w-full">
                    <div id="col-left" class="w-full sm:w-1/2 masonry-col sortable-col"></div>
                    <div id="col-right" class="w-full sm:w-1/2 masonry-col sortable-col"></div>
                </div>

            </div>
        </div>
    </main>

    <script>
        const API_KEY = "$2a$10$7PwFegDVLzoS8bJTQPdA7.27bk7D4odCTFnynWW1NkB5H6.PBt.nm";
        const BIN_ID = "698a256fd0ea881f40adab7d";
        const MONTHS = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const DEFAULT_STR = [
            { id: 'ing', title: 'Ingresos', type: 'income', items: ['Sueldo', 'Extras'], collapsed: false, col: 0 }, 
            { id: 'deu', title: 'Deudas', type: 'expense', items: ['Pr√©stamos'], collapsed: false, col: 1 },
            { id: 'fijos', title: 'Gastos Fijos', type: 'expense', items: ['Alquiler', 'Luz'], collapsed: false, col: 0 },
            { id: 'horm', title: 'Gastos Hormiga', type: 'expense', items: ['Netflix', 'Spotify'], collapsed: false, col: 1 },
            { id: 'aho', "title": 'Ahorros', type: 'savings', items: ['Fondo Emergencia'], collapsed: false, col: 0 }
        ];

        // NEW STATE MODEL: monthly_structures array
        let state = { currentMonth: 0, mode: 'view', allCollapsed: false, monthly_structures: [], data: {} };
        let ch1 = null, ch2 = null, trendChart = null, catChart = null;

        async function cloudPush() { document.getElementById('sync-text').innerText = "Guardando..."; try { await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, { method: 'PUT', headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY }, body: JSON.stringify({ monthly_structures: state.monthly_structures, data: state.data }) }); setTimeout(() => document.getElementById('sync-text').innerText = "Sincronizado", 800); } catch(e) { document.getElementById('sync-text').innerText = "Offline"; } }
        async function cloudPull() { try { const res = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, { headers: { 'X-Master-Key': API_KEY } }); const json = await res.json(); 
            if(json.record) { 
                // Migration Logic: If old "structure" exists but "monthly_structures" doesn't
                if (json.record.monthly_structures) {
                    state.monthly_structures = json.record.monthly_structures;
                } else if (json.record.structure) {
                    console.log("Migrating to Independent Structures...");
                    // Clone single structure to all 12 months
                    state.monthly_structures = Array(12).fill(null).map(() => JSON.parse(JSON.stringify(json.record.structure)));
                } else {
                    state.monthly_structures = Array(12).fill(null).map(() => JSON.parse(JSON.stringify(DEFAULT_STR)));
                }
                state.data = json.record.data || {}; 
                saveLocal(); 
                renderDashboard(); 
                document.getElementById('sync-status').style.opacity = '1'; document.getElementById('sync-text').innerText = "Sincronizado"; 
            } } catch(e) { document.getElementById('sync-text').innerText = "Offline"; } }

        function init() {
            const s = localStorage.getItem('finanzas_v42_independent');
            if(s) { 
                const p = JSON.parse(s); 
                state.monthly_structures = p.monthly_structures || Array(12).fill(null).map(() => JSON.parse(JSON.stringify(DEFAULT_STR)));
                // Migration local check
                if(!state.monthly_structures || state.monthly_structures.length === 0) {
                     state.monthly_structures = Array(12).fill(null).map(() => JSON.parse(JSON.stringify(p.structure || DEFAULT_STR)));
                }
                state.data = p.data || {}; 
            } else {
                state.monthly_structures = Array(12).fill(null).map(() => JSON.parse(JSON.stringify(DEFAULT_STR)));
            }
            cloudPull(); renderMenu(); renderDashboard();
            document.addEventListener('keydown', (e) => { if(e.key === 'Escape') closeAll(); });
            setInterval(() => { const styles = document.createElement('style'); styles.innerHTML = `* { cursor: default !important; } input[type="text"], input[type="number"], .cursor-pointer { cursor: pointer !important; } .cursor-text { cursor: text !important; }`; }, 1000);
        }

        function saveLocal() { localStorage.setItem('finanzas_v42_independent', JSON.stringify({ monthly_structures: state.monthly_structures, data: state.data })); }
        function commitChanges() { saveLocal(); cloudPush(); calcKPIs(false); }

        function renderDashboard() {
            document.getElementById('current-month-display').innerText = MONTHS[state.currentMonth];
            document.getElementById('delete-month-name').innerText = MONTHS[state.currentMonth];
            document.getElementById('breakdown-month-badge').innerText = MONTHS[state.currentMonth];
            const icon = document.getElementById('global-collapse-icon');
            if(state.allCollapsed) { icon.classList.remove('ph-arrows-out-line-vertical'); icon.classList.add('ph-arrows-in-line-vertical'); }
            else { icon.classList.add('ph-arrows-out-line-vertical'); icon.classList.remove('ph-arrows-in-line-vertical'); }

            const colLeft = document.getElementById('col-left');
            const colRight = document.getElementById('col-right');
            colLeft.innerHTML = ''; colRight.innerHTML = '';
            
            // USE CURRENT MONTH STRUCTURE ONLY
            const currentStruct = state.monthly_structures[state.currentMonth];

            currentStruct.forEach((sec, sIdx) => {
                let total = 0; sec.items.forEach((_, i) => total += (state.data[`${state.currentMonth}-${sec.id}-${i}`] || 0));
                let targetCol = sec.col; if (targetCol === undefined || targetCol === null) targetCol = sIdx % 2;
                const targetContainer = (targetCol === 1) ? colRight : colLeft;

                const card = document.createElement('div');
                card.setAttribute('data-db-id', sec.id); 
                card.className = `bg-white rounded-3xl card-premium overflow-hidden transition-all animate-slide-in ${state.mode==='edit'?'border-dashed border-2 border-slate-400 shadow-none':''}`;
                
                const isCollapsed = sec.collapsed === true;

                let html = `<div class="px-6 py-5 border-b border-slate-100 flex justify-between items-center bg-slate-50/50 section-header" onclick="toggleSection(${sIdx})">
                    <div class="flex items-center gap-3 w-full">
                        <span class="font-extrabold text-base text-slate-900 tracking-tight w-full pointer-events-none">${state.mode==='view' ? sec.title : `<input class="input-pro px-3 py-2 text-sm w-40 font-bold pointer-events-auto cursor-text" onclick="event.stopPropagation()" onchange="updStr('ren',${sIdx},0,this.value)" value="${sec.title}">`}</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <span class="font-extrabold text-slate-800 text-sm bg-white px-3 py-1 rounded-lg border border-slate-200 shadow-sm whitespace-nowrap">${formatMoney(total)}</span>
                        ${state.mode==='edit' 
                            ? `<div onclick="event.stopPropagation(); deleteSection(${sIdx})" class="w-8 h-8 rounded-full bg-rose-100 text-rose-500 flex items-center justify-center section-delete-btn hover:bg-rose-500 hover:text-white transition-colors cursor-pointer" title="Borrar Secci√≥n"><i class="ph-bold ph-trash"></i></div>` 
                            : `<div class="w-8 h-8 rounded-full bg-white flex items-center justify-center border border-slate-200"><i class="ph-bold ph-caret-down rotate-icon ${isCollapsed ? 'collapsed' : ''}"></i></div>`
                        }
                    </div>
                </div>
                <div class="accordion-content ${isCollapsed ? 'collapsed' : ''}">
                    <div class="p-6 space-y-5 item-sortable-list" data-idx="${sIdx}">`;

                sec.items.forEach((item, iIdx) => {
                    const key = `${state.currentMonth}-${sec.id}-${iIdx}`, val = state.data[key] || 0;
                    let displayVal = val !== 0 ? val.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : "";
                    html += `<div class="flex justify-between items-center text-sm group" data-item-idx="${iIdx}">
                        <div class="flex items-center gap-3">
                            ${state.mode==='edit' ? '<i class="ph-bold ph-dots-six-vertical drag-handle text-lg text-slate-300 hover:text-slate-600"></i>' : ''}
                            <span class="text-slate-700 font-bold text-[15px] group-hover:text-black transition-colors">${state.mode==='view' ? item : `<input class="border-b-2 border-slate-300 font-bold cursor-text" onclick="event.stopPropagation()" onchange="updStr('renI',${sIdx},${iIdx},this.value)" value="${item}">`}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="relative"><input type="text" inputmode="decimal" id="inp-${sIdx}-${iIdx}" value="${displayVal}" placeholder="0,00" class="input-pro w-32 py-2.5 pl-3 pr-3 text-right font-extrabold text-slate-900 placeholder:text-slate-300 focus:bg-white cursor-text" onclick="event.stopPropagation()" onfocus="this.value='${val===0?'':val}'" onblur="updVal('${key}',this.value)" onkeydown="handleInputKey(event, ${sIdx}, ${iIdx})"></div>
                            ${state.mode==='edit' ? `<button onclick="deleteItem(${sIdx}, ${iIdx})" class="w-8 h-8 rounded-lg bg-rose-50 text-rose-400 hover:bg-rose-500 hover:text-white btn-delete-item flex items-center justify-center"><i class="ph-bold ph-trash"></i></button>` : ''}
                        </div>
                    </div><div class="border-b border-slate-100 last:border-0"></div>`;
                });
                
                if(state.mode==='edit') html += `<button onclick="event.stopPropagation(); updStr('addI',${sIdx})" class="w-full py-3 text-xs font-bold border-2 border-dashed border-slate-300 rounded-xl text-slate-500 hover:text-brand-600 hover:border-brand-500 hover:bg-brand-50 transition-all mt-2 btn-anim cursor-pointer">+ A√±adir Concepto</button>`;
                html += `</div></div>`;
                card.innerHTML = html;
                targetContainer.appendChild(card);
            });
            
            if(state.mode==='edit') {
                 const btn = document.createElement('div'); btn.className="border-4 border-dashed border-slate-200 rounded-3xl p-8 flex items-center justify-center cursor-pointer hover:border-brand-400 hover:bg-brand-50 transition-all btn-anim mt-6";
                 btn.innerHTML=`<span class="text-slate-400 font-extrabold text-sm uppercase tracking-widest">+ Nueva Secci√≥n</span>`;
                 btn.onclick=()=>updStr('addSec'); 
                 colLeft.appendChild(btn); 
                 document.body.classList.add('edit-mode');
            } else {
                 document.body.classList.remove('edit-mode');
            }
            initSortable();
            calcKPIs(false);
        }

        function getStruct() { return state.monthly_structures[state.currentMonth]; }

        function deleteItem(sIdx, iIdx) {
            if(!confirm('¬øEliminar este concepto?')) return;
            getStruct()[sIdx].items.splice(iIdx, 1);
            commitChanges();
            renderDashboard();
        }

        function deleteSection(sIdx) {
            if(!confirm('¬øEliminar TODA la secci√≥n y sus datos?')) return;
            const secId = getStruct()[sIdx].id;
            Object.keys(state.data).forEach(k => { if(k.startsWith(`${state.currentMonth}-${secId}-`)) delete state.data[k]; });
            getStruct().splice(sIdx, 1);
            commitChanges();
            renderDashboard();
        }

        function toggleSection(sIdx) { const s=getStruct()[sIdx]; s.collapsed = !s.collapsed; renderDashboard(); }
        function toggleGlobalCollapse() { state.allCollapsed = !state.allCollapsed; getStruct().forEach(sec => sec.collapsed = state.allCollapsed); renderDashboard(); }
        
        // Updates target ONLY current month structure
        function updStr(act,s,i,v) { 
            const st = getStruct();
            if(act==='ren') st[s].title=v; 
            if(act==='renI') st[s].items[i]=v; 
            if(act==='addI') st[s].items.push("Nuevo"); 
            if(act==='addSec') st.push({id:'s'+Date.now(), title:'Nueva Secci√≥n', type:'expense', items:['Concepto'], col: 0}); 
            commitChanges(); renderDashboard(); 
        }

        function handleInputKey(e, sIdx, iIdx) { if(e.key === 'Enter' || e.key === 'Tab') { e.preventDefault(); e.target.blur(); const nextInput = document.getElementById(`inp-${sIdx}-${iIdx+1}`); if(nextInput) nextInput.focus(); } }
        
        function initSortable() {
            const cols = [document.getElementById('col-left'), document.getElementById('col-right')];
            cols.forEach(col => {
                new Sortable(col, { group: 'shared', handle: '.section-header', animation: 200, ghostClass: 'sortable-ghost', onEnd: function (evt) {
                         const newStructure = [];
                         const st = getStruct();
                         // We need to reconstruct items based on DOM order because we are in independent mode
                         // Map DOM IDs back to structure objects
                         Array.from(document.getElementById('col-left').children).forEach(el => { 
                             if(el.hasAttribute('data-db-id')) { 
                                 const item = st.find(s => s.id === el.getAttribute('data-db-id')); 
                                 if(item) { item.col = 0; newStructure.push(item); } 
                             } 
                         });
                         Array.from(document.getElementById('col-right').children).forEach(el => { 
                             if(el.hasAttribute('data-db-id')) { 
                                 const item = st.find(s => s.id === el.getAttribute('data-db-id')); 
                                 if(item) { item.col = 1; newStructure.push(item); } 
                             } 
                         });
                         // Update ONLY current month structure
                         state.monthly_structures[state.currentMonth] = newStructure;
                         commitChanges(); renderDashboard();
                }});
            });
            document.querySelectorAll('.item-sortable-list').forEach(el => { new Sortable(el, { handle: '.drag-handle', animation: 200, ghostClass: 'sortable-ghost', onEnd: function (evt) { const secIdx = parseInt(evt.to.getAttribute('data-idx')); const oldIdx = Math.floor(evt.oldIndex / 2); const newIdx = Math.floor(evt.newIndex / 2); const items = getStruct()[secIdx].items; const [movedItem] = items.splice(oldIdx, 1); items.splice(newIdx, 0, movedItem); commitChanges(); renderDashboard(); }}); });
        }

        function setMode(m) { state.mode = m; document.getElementById('btn-view').className = m==='view' ? "px-5 py-2 text-xs font-bold rounded-lg bg-slate-900 text-white shadow transition-all btn-anim cursor-pointer" : "px-5 py-2 text-xs font-bold rounded-lg text-slate-500 hover:text-slate-800 bg-white border border-slate-200 transition-all btn-anim cursor-pointer"; document.getElementById('btn-edit').className = m==='edit' ? "px-5 py-2 text-xs font-bold rounded-lg bg-slate-900 text-white shadow transition-all btn-anim cursor-pointer" : "px-5 py-2 text-xs font-bold rounded-lg text-slate-500 hover:text-slate-800 bg-white border border-slate-200 transition-all btn-anim cursor-pointer"; renderDashboard(); }
        
        // --- CFO ANALYTICS (Same Logic, updated references) ---
        function refreshAnalysis() { const ph = document.getElementById('advisor-placeholder'); ph.innerHTML = `<i class="ph-bold ph-spinner animate-spin"></i> Procesando datos...`; setTimeout(() => { calcKPIs(true); }, 800); }
        function analyzeFinance(i, e, s, bd_details) {
            const tipsContainer = document.getElementById('advisor-tips'); const placeholder = document.getElementById('advisor-placeholder'); const scoreEl = document.getElementById('health-score'); const barEl = document.getElementById('health-bar'); const statusEl = document.getElementById('advisor-status');
            if(i === 0) { scoreEl.innerText = "0"; barEl.style.width = "0%"; statusEl.innerText = "Esperando Ingresos"; tipsContainer.classList.add('hidden'); placeholder.classList.remove('hidden'); placeholder.innerHTML = `<i class="ph-bold ph-info"></i> Registra tus ingresos para iniciar el an√°lisis.`; return; }
            const balance = i - e - s; const savingsRate = (s / i) * 100; const debt = bd_details['Deudas'] || bd_details['Deudas & Pr√©stamos'] || 0; const debtRatio = (debt / i) * 100; const hormiga = bd_details['Gastos Hormiga'] || 0; const annualHormiga = hormiga * 12;
            let score = 100; if (balance < 0) score -= 40; if (savingsRate < 20) score -= (20 - savingsRate); if (debtRatio > 30) score -= (debtRatio - 30); if (hormiga > (i * 0.05)) score -= 10; score = Math.max(0, Math.min(100, Math.round(score)));
            scoreEl.innerText = score; barEl.style.width = `${score}%`;
            let colorClass = "bg-emerald-500"; let statusText = "Excelente"; if (score < 80) { colorClass = "bg-blue-500"; statusText = "Bueno"; } if (score < 60) { colorClass = "bg-yellow-500"; statusText = "Aceptable"; } if (score < 40) { colorClass = "bg-orange-500"; statusText = "En Riesgo"; } if (score < 20) { colorClass = "bg-rose-500"; statusText = "Cr√≠tico"; }
            barEl.className = `health-bar-fill ${colorClass}`; statusEl.innerText = statusText; statusEl.className = `mt-3 text-sm font-bold ${colorClass.replace('bg-', 'text-')}`;
            let strategies = [];
            if (debtRatio > 0) { if (debtRatio > 35) { strategies.push({icon: "üìâ", title: "Alerta de Endeudamiento", text: `Tus deudas consumen el ${debtRatio.toFixed(0)}% de tu ingreso. <b>Acci√≥n:</b> Aplica el m√©todo 'Bola de Nieve' (paga la m√°s chica primero) para liberar flujo de caja.`}); } else { strategies.push({icon: "üí≥", title: "Control de Deuda", text: `Est√°s destinando S/ ${debt.toFixed(2)} a deuda. Si puedes prepagar, hazlo para ahorrar intereses futuros.`}); } }
            if (savingsRate < 20) { const gap = (i * 0.20) - s; strategies.push({icon: "üí∞", title: "Objetivo de Ahorro (Regla 20%)", text: `Est√°s ahorrando el ${savingsRate.toFixed(0)}%. Para llegar al ideal del 20%, deber√≠as separar <b>S/ ${gap.toFixed(2)} adicionales</b> este mes.`}); } else { strategies.push({icon: "üöÄ", title: "Ahorro Potente", text: `¬°Bien! Superas el 20% de ahorro. Considera mover el excedente a un Fondo Mutuo o Dep√≥sito a Plazo.`}); }
            if (hormiga > 0) { strategies.push({icon: "‚òï", title: "Fuga 'Hormiga'", text: `Cuidado: Si mantienes este ritmo de gastos peque√±os, perder√°s <b>S/ ${annualHormiga.toFixed(2)} al a√±o</b>. ¬øVale la pena?`}); }
            if (balance < 0) { strategies.unshift({icon: "üö®", title: "D√âFICIT DETECTADO", text: `Est√°s gastando S/ ${Math.abs(balance).toFixed(2)} m√°s de lo que ingresas. Det√©n gastos variables inmediatamente.`}); } else if (balance > 0 && savingsRate < 10) { strategies.push({icon: "üëÅÔ∏è", title: "Dinero Ocioso", text: `Tienes S/ ${balance.toFixed(2)} libres sin asignar a ahorro. ¬°No los gastes! Mu√©velos a tu meta de ahorro.`}); }
            tipsContainer.innerHTML = ""; strategies.slice(0, 3).forEach(t => { tipsContainer.innerHTML += `<div class="coach-tip-item"><div class="coach-icon">${t.icon}</div><div class="coach-text"><strong>${t.title}</strong>${t.text}</div></div>`; });
            tipsContainer.classList.remove('hidden'); placeholder.classList.add('hidden');
        }

        function calcKPIs(runAnalysis = false) {
            let i=0, e=0, s=0, bd={};
            // Use getStruct() so we analyze only current month's structure
            getStruct().forEach(sec => { let sum = 0; sec.items.forEach((_, idx) => sum += (state.data[`${state.currentMonth}-${sec.id}-${idx}`] || 0)); if(sec.type==='income') i += sum; else if(sec.type==='savings') s += sum; else { e += sum; if(sum > 0) bd[sec.title] = sum; } });
            const bal = i-e-s;
            document.getElementById('kpi-balance').innerText = formatMoney(bal); document.getElementById('kpi-income').innerText = formatMoney(i); document.getElementById('kpi-expenses').innerText = formatMoney(e); document.getElementById('kpi-savings').innerText = formatMoney(s); document.getElementById('center-total').innerText = formatMoney(e); document.getElementById('kpi-rate').innerText = i>0 ? ((s/i)*100).toFixed(0)+'%' : '0%';
            if(runAnalysis) analyzeFinance(i, e, s, bd);
            const ctx1 = document.getElementById('expenseChart'); if (ch1) ch1.destroy(); ch1 = new Chart(ctx1, { type: 'doughnut', data: { labels: Object.keys(bd), datasets: [{ data: Object.values(bd), backgroundColor: ['#f97316', '#14b8a6', '#6366f1', '#ec4899', '#f59e0b'], borderWidth: 0, borderRadius: 6, spacing: 6 }] }, options: { responsive:true, maintainAspectRatio:false, cutout:'90%', layout:{padding:20}, plugins:{legend:{display:false}} } });
            const ctx2 = document.getElementById('flowChart'); if (ch2) ch2.destroy(); ch2 = new Chart(ctx2, { type: 'bar', data: { labels: ['Ingresos','Gastos','Ahorro'], datasets: [{ data:[i,e,s], backgroundColor:['#10b981','#f97316','#3b82f6'], borderRadius:12, barPercentage:0.45 }] }, options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{display:false}, x:{grid:{display:false}}} } });
            if(document.getElementById('analytics-overlay').classList.contains('open')) renderAdvancedCharts();
        }
        function renderAdvancedCharts() { 
            const incomeTrend=[], expenseTrend=[]; 
            MONTHS.forEach((_, mIdx) => { 
                let i=0, e=0; 
                // Careful: Historical charts now need to loop through specific monthly structures
                const mStruct = state.monthly_structures[mIdx];
                mStruct.forEach(sec => { let sum=0; sec.items.forEach((_, idx) => sum += (state.data[`${mIdx}-${sec.id}-${idx}`] || 0)); if(sec.type==='income') i+=sum; else if(sec.type!=='savings') e+=sum; }); 
                incomeTrend.push(i); expenseTrend.push(e); 
            }); 
            const ctxT = document.getElementById('trendChart'); if(trendChart) trendChart.destroy(); trendChart = new Chart(ctxT, { type: 'line', data: { labels: MONTHS, datasets: [ { label: 'Ingresos', data: incomeTrend, borderColor: '#10b981', backgroundColor: 'rgba(16,185,129,0.1)', fill: true, tension: 0.4 }, { label: 'Gastos', data: expenseTrend, borderColor: '#f97316', backgroundColor: 'rgba(249,115,22,0.1)', fill: true, tension: 0.4 } ] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } } }); const categories = {}; getStruct().forEach(sec => { if(sec.type === 'expense') { let sum=0; sec.items.forEach((_, idx) => sum += (state.data[`${state.currentMonth}-${sec.id}-${idx}`] || 0)); if(sum > 0) categories[sec.title] = sum; } }); const ctxC = document.getElementById('categoryChart'); if(catChart) catChart.destroy(); catChart = new Chart(ctxC, { type: 'bar', data: { labels: Object.keys(categories), datasets: [{ label: 'Gasto por Categor√≠a', data: Object.values(categories), backgroundColor: '#3b82f6', borderRadius: 8 }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false } }); 
        }

        function openDeleteModal() { document.getElementById('delete-modal').classList.add('open'); document.getElementById('settings-modal').classList.remove('open'); }
        function executeDelete() { 
            const prefix = `${state.currentMonth}-`; 
            closeAll();
            const container = document.getElementById('dashboard-content');
            container.classList.add('vanish-effect');
            setTimeout(() => {
                Object.keys(state.data).forEach(k => { if(k.startsWith(prefix)) delete state.data[k]; }); 
                commitChanges(); 
                const successOverlay = document.getElementById('success-overlay');
                successOverlay.classList.add('show');
                renderDashboard();
                container.classList.remove('vanish-effect');
                setTimeout(() => { successOverlay.classList.remove('show'); }, 1500);
            }, 500); 
        }
        function updVal(k, v) { let floatVal = parseFloat(v.replace(',', '.')) || 0; state.data[k] = floatVal; commitChanges(); renderDashboard(); }
        function formatMoney(n) { return "S/ " + n.toLocaleString('es-ES', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
        
        function openAnalytics() { document.getElementById('analytics-overlay').classList.add('open'); renderAdvancedCharts(); }
        function closeAnalytics() { document.getElementById('analytics-overlay').classList.remove('open'); }
        function openMenu() { document.getElementById('drawer').classList.add('open'); document.getElementById('main-backdrop').classList.add('open'); }
        function openSettings() { document.getElementById('settings-modal').classList.add('open'); document.getElementById('main-backdrop').classList.add('open'); }
        function closeAll() { document.getElementById('drawer').classList.remove('open'); document.getElementById('main-backdrop').classList.remove('open'); document.querySelectorAll('.modal-container').forEach(m => m.classList.remove('open')); closeAnalytics(); }
        function renderMenu() { const nav = document.getElementById('month-nav-container'); nav.innerHTML = ''; MONTHS.forEach((m,i) => { const b = document.createElement('button'); b.className = `w-full text-left px-5 py-4 rounded-2xl transition-all mb-1 btn-anim cursor-pointer ${i===state.currentMonth?'bg-slate-900 text-white font-bold shadow-lg shadow-slate-300':'text-slate-500 hover:bg-slate-100 hover:text-slate-900 font-bold'}`; b.innerText = m; b.onclick = () => { state.currentMonth=i; renderMenu(); renderDashboard(); closeAll(); }; nav.appendChild(b); }); }
        
        // --- SMART CLONE ---
        function openCloneModal() { const sel=document.getElementById('target-month-select'); sel.innerHTML=''; MONTHS.forEach((m,i)=>{if(i!==state.currentMonth){const o=document.createElement('option');o.value=i;o.innerText=m;if(i===state.currentMonth+1)o.selected=true;sel.appendChild(o);}}); document.getElementById('clone-modal').classList.add('open'); document.getElementById('main-backdrop').classList.add('open'); }
        function executeClone() { 
            const dest=parseInt(document.getElementById('target-month-select').value); 
            const sp=`${state.currentMonth}-`, dp=`${dest}-`; 
            
            // 1. Clone Structure
            state.monthly_structures[dest] = JSON.parse(JSON.stringify(state.monthly_structures[state.currentMonth]));
            
            // 2. Clone Data
            Object.keys(state.data).forEach(k=>{if(k.startsWith(dp))delete state.data[k];}); 
            Object.keys(state.data).forEach(k=>{if(k.startsWith(sp))state.data[dp+k.substring(sp.length)]=state.data[k];}); 
            
            state.currentMonth=dest; commitChanges(); renderMenu(); renderDashboard(); closeAll(); showToast(`Copiado a ${MONTHS[dest]}`); 
        }
        function exportExcel(scope) { let csv = "\uFEFFMes,Secci√≥n,Item,Monto (S/)\n"; const processMonth = (mIdx) => { state.monthly_structures[mIdx].forEach(sec => { sec.items.forEach((item, iIdx) => { const val = state.data[`${mIdx}-${sec.id}-${iIdx}`] || 0; if (val !== 0) csv += `${MONTHS[mIdx]},"${sec.title}","${item}","${val.toFixed(2).replace('.', ',')}"\n`; }); }); }; if (scope === 'current') processMonth(state.currentMonth); else MONTHS.forEach((_, idx) => processMonth(idx)); const link = document.createElement("a"); link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' })); link.download = `Reporte_${scope === 'current' ? MONTHS[state.currentMonth] : 'Anual'}.csv`; document.body.appendChild(link); link.click(); document.body.removeChild(link); closeAll(); showToast("Descargado"); }
        function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.classList.remove('hidden'); t.classList.add('show'); setTimeout(()=>{t.classList.remove('show'); t.classList.add('hidden');},3000); }
        function resetAll() { if(confirm('¬øReiniciar todo de f√°brica?')) { localStorage.removeItem('finanzas_v42_independent'); localStorage.removeItem('v40_forced_distribution_done'); location.reload(); }}

        init();
    </script>
</body>
</html>
