<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Finanzas V15 - Zen Mode</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: {
                        brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1' },
                        slate: { 850: '#1e293b' }
                    },
                    animation: { 'fade-in': 'fadeIn 0.5s ease-out forwards' },
                    keyframes: { fadeIn: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } } }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; color: #0f172a; }
        
        /* Sidebar Oculto por defecto (Off-canvas) */
        .sidebar-drawer { 
            transform: translateX(-100%); 
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            z-index: 50;
            position: fixed; top: 0; left: 0; bottom: 0; width: 18rem; 
            background: white; border-right: 1px solid #e2e8f0;
        }
        .sidebar-drawer.open { transform: translateX(0); }
        
        /* Backdrop */
        .backdrop { opacity: 0; pointer-events: none; transition: opacity 0.3s; background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(4px); position: fixed; inset: 0; z-index: 40; }
        .backdrop.open { opacity: 1; pointer-events: auto; }

        /* Modal Clone */
        .modal-container { opacity: 0; pointer-events: none; transition: all 0.3s; transform: scale(0.95); z-index: 60; }
        .modal-container.open { opacity: 1; pointer-events: auto; transform: scale(1); }

        /* Toast */
        .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(20px); background: #0f172a; color: white; padding: 12px 24px; border-radius: 99px; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); opacity: 0; transition: all 0.4s; pointer-events: none; z-index: 100; font-size: 0.9rem; font-weight: 500; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; border: 2px solid #f8fafc; }
        .input-pro { border: 1px solid #e2e8f0; transition: all 0.2s; background: #fff; }
        .input-pro:focus { border-color: #0ea5e9; box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1); outline: none; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02); }
    </style>
</head>
<body class="h-[100dvh] flex overflow-hidden bg-[#f8fafc]">

    <div id="main-backdrop" class="backdrop" onclick="closeMenu()"></div>
    <div id="toast" class="toast flex items-center gap-2"><i class="ph-fill ph-check-circle text-emerald-400 text-xl"></i><span id="toast-msg">Listo</span></div>

    <div id="clone-modal" class="fixed inset-0 flex items-center justify-center p-4 modal-container">
        <div class="absolute inset-0" onclick="closeModal()"></div>
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md relative overflow-hidden z-10 animate-fade-in">
            <div class="bg-white border-b border-slate-100 p-5 flex justify-between items-center">
                <h3 class="font-bold text-slate-800 flex items-center gap-2 text-lg"><div class="bg-brand-50 text-brand-600 p-2 rounded-lg"><i class="ph-bold ph-copy"></i></div> Duplicar Mes</h3>
                <button onclick="closeModal()" class="text-slate-400 hover:text-slate-700 transition-colors"><i class="ph-bold ph-x text-xl"></i></button>
            </div>
            <div class="p-6">
                <p class="text-sm text-slate-500 mb-5 leading-relaxed">Se copiarán datos de <b id="src-month-name" class="text-slate-800">Mes Actual</b> al mes destino.</p>
                <div class="relative mb-6">
                    <select id="target-month-select" class="w-full appearance-none bg-slate-50 border border-slate-200 text-slate-700 font-bold py-3.5 px-4 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-500 transition-shadow cursor-pointer"></select>
                    <div class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"><i class="ph-bold ph-caret-down"></i></div>
                </div>
                <button onclick="executeClone()" class="w-full py-3.5 rounded-xl font-bold text-sm text-white bg-brand-600 hover:bg-brand-700 transition-all shadow-lg shadow-brand-500/25 flex justify-center items-center gap-2">Confirmar <i class="ph-bold ph-arrow-right"></i></button>
            </div>
        </div>
    </div>

    <aside id="drawer" class="sidebar-drawer shadow-2xl flex flex-col">
        <div class="h-20 flex items-center px-6 border-b border-slate-100 bg-white justify-between">
            <div class="flex items-center gap-3.5">
                <div class="w-10 h-10 bg-gradient-to-br from-brand-500 to-brand-700 rounded-xl flex items-center justify-center text-white shadow-lg shadow-brand-500/20"><i class="ph-bold ph-chart-polar text-xl"></i></div>
                <div><h1 class="font-bold text-lg tracking-tight text-slate-800">Finanzas</h1><p class="text-[11px] text-slate-400 font-semibold uppercase tracking-wide">V15 Zen</p></div>
            </div>
            <button onclick="closeMenu()" class="text-slate-400 hover:text-slate-800 p-2"><i class="ph-bold ph-x text-xl"></i></button>
        </div>
        
        <nav class="flex-1 overflow-y-auto px-4 py-6 space-y-1">
            <label class="px-2 text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 block">Navegación</label>
            <div id="month-nav-container" class="space-y-1"></div>
        </nav>

        <div class="p-5 border-t border-slate-100 bg-slate-50/50 space-y-3">
            <button onclick="openCloneModal()" class="w-full group text-xs bg-white border border-brand-200 text-brand-700 hover:bg-brand-600 hover:text-white py-3 rounded-xl font-bold shadow-sm transition-all flex items-center justify-center gap-2"><i class="ph-bold ph-copy text-brand-500 group-hover:text-white"></i> Duplicar Mes</button>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="exportData()" class="flex flex-col items-center justify-center p-2.5 bg-white border border-slate-200 rounded-xl text-slate-500 text-[10px] font-bold hover:bg-white hover:border-brand-300 hover:text-brand-600 transition-all"><i class="ph-bold ph-download-simple mb-1 text-base"></i>Backup</button>
                <label class="flex flex-col items-center justify-center p-2.5 bg-white border border-slate-200 rounded-xl text-slate-500 text-[10px] font-bold hover:bg-white hover:border-brand-300 hover:text-brand-600 transition-all cursor-pointer"><i class="ph-bold ph-upload-simple mb-1 text-base"></i>Restaurar<input type="file" class="hidden" onchange="importData(this)"></label>
            </div>
            <button onclick="resetAll()" class="w-full text-[10px] text-rose-400 hover:text-rose-600 py-2 font-medium">Reiniciar</button>
        </div>
    </aside>

    <main class="flex-1 flex flex-col h-full relative w-full bg-[#f8fafc]">
        
        <header class="h-20 bg-white/80 backdrop-blur-md border-b border-slate-200/60 flex items-center justify-between px-6 md:px-10 shadow-sm z-10 sticky top-0 flex-none transition-all">
            <div class="flex items-center gap-4">
                <button onclick="openMenu()" class="p-2 -ml-2 text-slate-600 hover:bg-slate-100 rounded-xl transition-all active:scale-95 group">
                    <i class="ph-bold ph-list text-3xl group-hover:text-brand-600"></i>
                </button>
                
                <div>
                    <h2 id="current-month-display" class="text-2xl font-bold text-slate-800 tracking-tight">Enero 2026</h2>
                </div>
            </div>
            
            <div class="flex items-center bg-slate-100/80 p-1 rounded-xl border border-slate-200">
                <button onclick="setMode('view')" id="btn-view" class="px-4 py-2 text-xs font-bold rounded-lg shadow-sm bg-white text-slate-800 transition-all flex items-center gap-2"><i class="ph-bold ph-eye"></i> Ver</button>
                <button onclick="setMode('edit')" id="btn-edit" class="px-4 py-2 text-xs font-bold rounded-lg text-slate-500 hover:text-slate-900 transition-all flex items-center gap-2"><i class="ph-bold ph-pencil-simple"></i> Editar</button>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-4 md:p-8 relative custom-scrollbar" id="main-scroll">
            <div class="max-w-7xl mx-auto space-y-8 pb-32">
                
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 animate-fade-in">
                    <div class="bg-white p-6 rounded-2xl card-shadow border border-slate-100/60 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-4 opacity-[0.03] group-hover:opacity-10 transition-opacity"><i class="ph-fill ph-wallet text-6xl"></i></div>
                        <p class="text-slate-400 text-[11px] font-bold uppercase tracking-widest mb-1">Disponible</p>
                        <h3 class="text-3xl font-bold text-slate-800 tracking-tight" id="kpi-balance">S/ 0.00</h3>
                    </div>
                    <div class="bg-white p-6 rounded-2xl card-shadow border border-slate-100/60 border-l-4 border-l-emerald-500"><p class="text-slate-400 text-[11px] font-bold uppercase tracking-widest mb-1">Ingresos</p><h3 class="text-2xl font-bold text-emerald-600 tracking-tight" id="kpi-income">S/ 0.00</h3></div>
                    <div class="bg-white p-6 rounded-2xl card-shadow border border-slate-100/60 border-l-4 border-l-rose-500"><p class="text-slate-400 text-[11px] font-bold uppercase tracking-widest mb-1">Gastos</p><h3 class="text-2xl font-bold text-rose-600 tracking-tight" id="kpi-expenses">S/ 0.00</h3></div>
                    <div class="bg-white p-6 rounded-2xl card-shadow border border-slate-100/60 border-l-4 border-l-brand-500"><div class="flex justify-between items-center mb-1"><p class="text-slate-400 text-[11px] font-bold uppercase tracking-widest">Ahorro</p><span id="kpi-rate" class="text-[10px] bg-brand-50 text-brand-700 px-2 py-0.5 rounded-full font-bold border border-brand-100">0%</span></div><h3 class="text-2xl font-bold text-brand-600 tracking-tight" id="kpi-savings">S/ 0.00</h3></div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fade-in" id="charts-container" style="animation-delay: 100ms;">
                    
                    <div class="bg-white p-6 rounded-2xl card-shadow border border-slate-100/60 h-80 flex flex-col relative">
                        <div class="flex justify-between items-center mb-4"><h4 class="text-slate-700 font-bold text-xs uppercase tracking-wider flex items-center gap-2"><i class="ph-bold ph-chart-pie-slice text-brand-500"></i> Distribución</h4></div>
                        <div class="flex-1 relative">
                            <canvas id="expenseChart"></canvas>
                            <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                                <span class="text-[10px] text-slate-400 font-bold uppercase">Total Gastado</span>
                                <span class="text-xl font-bold text-slate-800" id="center-total">S/ 0</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl card-shadow border border-slate-100/60 h-80 col-span-1 lg:col-span-2 flex flex-col">
                        <h4 class="text-slate-700 font-bold text-xs uppercase tracking-wider mb-4 flex items-center gap-2"><i class="ph-bold ph-chart-bar text-brand-500"></i> Flujo Mensual</h4>
                        <div class="flex-1 relative w-full"><canvas id="flowChart"></canvas></div>
                    </div>
                </div>

                <div class="space-y-6 animate-fade-in" style="animation-delay: 200ms;">
                    <div class="flex items-center gap-4">
                        <h3 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="ph-fill ph-list-dashes text-slate-400"></i> Transacciones</h3>
                        <div class="h-px bg-slate-200 flex-1"></div>
                    </div>
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6" id="sections-container"></div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const MONTHS = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const DEFAULT_STRUCTURE = [{ id: 'ing', title: 'Ingresos', type: 'income', items: ['Sueldo', 'Extras'] }, { id: 'gas', title: 'Gastos Fijos', type: 'expense', items: ['Alquiler', 'Servicios'] }, { id: 'horm', title: 'Gastos Hormiga', type: 'expense', items: ['Netflix', 'Spotify'] }, { id: 'deu', title: 'Deudas', type: 'expense', items: ['Préstamo'] }, { id: 'aho', title: 'Ahorros', type: 'savings', items: ['Fondo Emergencia'] }];
        let state = { currentMonth: 0, mode: 'view', structure: [], data: {} };
        let chart1 = null, chart2 = null;

        function init() {
            try { const s = localStorage.getItem('finanzas_V15'); if(s) { const p=JSON.parse(s); state.structure=p.structure; state.data=p.data; } else state.structure=JSON.parse(JSON.stringify(DEFAULT_STRUCTURE)); } catch(e) { state.structure=JSON.parse(JSON.stringify(DEFAULT_STRUCTURE)); }
            renderMenu(); renderDashboard();
        }

        // --- VISUALIZACIÓN ---
        function openMenu() { document.getElementById('drawer').classList.add('open'); document.getElementById('main-backdrop').classList.add('open'); }
        function closeMenu() { document.getElementById('drawer').classList.remove('open'); document.getElementById('main-backdrop').classList.remove('open'); closeModal(); }
        function renderMenu() {
            const nav = document.getElementById('month-nav-container'); nav.innerHTML='';
            MONTHS.forEach((m,i) => {
                const b = document.createElement('button');
                b.className = `w-full text-left px-3.5 py-2.5 rounded-xl text-sm font-medium transition-all flex justify-between items-center ${i===state.currentMonth?'bg-brand-50 text-brand-700 font-bold':'text-slate-500 hover:bg-slate-50'}`;
                b.innerHTML = `<span>${m}</span>${i===state.currentMonth?'<span class="w-2 h-2 rounded-full bg-brand-500"></span>':''}`;
                b.onclick = () => { state.currentMonth=i; renderMenu(); renderDashboard(); closeMenu(); };
                nav.appendChild(b);
            });
        }

        function renderDashboard() {
            document.getElementById('current-month-display').innerText = MONTHS[state.currentMonth] + " 2026";
            const container = document.getElementById('sections-container'); if(!container) return; container.innerHTML='';
            
            state.structure.forEach((sec, sIdx) => {
                let secTotal = 0; sec.items.forEach((_, i) => secTotal += (state.data[`${state.currentMonth}-${sec.id}-${i}`] || 0));
                const isInc = sec.type === 'income', isSav = sec.type === 'savings';
                const accent = isInc ? 'emerald' : (isSav ? 'brand' : 'rose');
                const colors = { emerald: 'text-emerald-600 bg-emerald-50', brand: 'text-brand-600 bg-brand-50', rose: 'text-rose-600 bg-rose-50' };

                const card = document.createElement('div');
                card.className = `bg-white rounded-2xl card-shadow border border-slate-100/80 flex flex-col overflow-hidden ${state.mode==='edit'?'border-dashed border-slate-300':''}`;
                
                let header = state.mode === 'view' ? 
                    `<div class="px-5 py-4 border-b border-slate-50 flex justify-between items-center bg-white"><div class="font-bold text-slate-700 flex items-center gap-2.5 text-sm"><div class="p-1.5 rounded-lg ${colors[accent]}"><i class="ph-bold ${isInc?'ph-money':(isSav?'ph-piggy-bank':'ph-receipt')}"></i></div>${sec.title}</div><div class="font-mono font-bold text-slate-700 text-sm bg-slate-50 px-2.5 py-1 rounded-lg border border-slate-100">S/ ${formatMoney(secTotal)}</div></div>` :
                    `<div class="px-5 py-3 bg-slate-50 border-b border-slate-200 flex flex-col gap-2"><div class="flex gap-2"><input type="text" value="${sec.title}" class="input-pro rounded-lg px-3 py-1.5 text-sm font-bold w-full bg-white" onchange="updStr('renameSec',${sIdx},null,this.value)"><button onclick="updStr('delSec',${sIdx})" class="text-rose-500 bg-white border border-rose-200 rounded-lg p-1.5 hover:bg-rose-50"><i class="ph-bold ph-trash"></i></button></div><select onchange="updStr('changeType',${sIdx},null,this.value)" class="input-pro text-xs rounded-lg px-2 py-1.5 bg-white font-medium text-slate-600"><option value="income" ${isInc?'selected':''}>Ingreso</option><option value="expense" ${sec.type==='expense'?'selected':''}>Gasto</option><option value="savings" ${isSav?'selected':''}>Ahorro</option></select></div>`;

                let body = `<div class="p-5 space-y-3 bg-white flex-1">`;
                sec.items.forEach((item, iIdx) => {
                    const key = `${state.currentMonth}-${sec.id}-${iIdx}`, val = state.data[key] || 0;
                    body += state.mode === 'view' ? 
                        `<div class="flex justify-between items-center group"><label class="text-xs md:text-sm text-slate-500 font-medium truncate pr-2 w-1/2 group-hover:text-slate-800 transition-colors">${item}</label><div class="relative w-32"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-[10px] pointer-events-none">S/</span><input type="number" step="0.1" value="${val===0?'':val}" placeholder="0" class="input-pro w-full rounded-lg py-1.5 pl-7 pr-3 text-right text-sm font-semibold text-slate-700 hover:border-slate-300" onchange="updVal('${key}',this.value)"></div></div>` :
                        `<div class="flex gap-2 items-center"><button onclick="updStr('delItem',${sIdx},${iIdx})" class="text-rose-400 hover:text-rose-600"><i class="ph-bold ph-minus-circle"></i></button><input type="text" value="${item}" class="input-pro border-0 border-b w-full text-sm py-1 bg-transparent" onchange="updStr('renameItem',${sIdx},${iIdx},this.value)"></div>`;
                });
                if(state.mode==='edit') body += `<button onclick="updStr('addItem',${sIdx})" class="w-full mt-3 py-2 text-xs font-bold border border-dashed border-slate-300 text-slate-400 rounded-lg hover:text-brand-600 hover:border-brand-400 hover:bg-brand-50 transition-all">+ Añadir Fila</button>`;
                body += `</div>`; card.innerHTML = header + body; container.appendChild(card);
            });
            if(state.mode==='edit') { const b=document.createElement('div'); b.className="border-2 border-dashed border-slate-300 rounded-2xl p-6 flex flex-col items-center justify-center cursor-pointer hover:bg-slate-50 hover:border-brand-300 transition-all min-h-[120px]"; b.onclick=()=>updStr('addSec'); b.innerHTML=`<i class="ph-bold ph-plus text-3xl text-slate-300 mb-2"></i><span class="text-sm font-bold text-slate-400">Crear Sección</span>`; container.appendChild(b); }
            calcKPIs();
        }

        // --- GRÁFICOS PULIDOS ---
        function renderCharts(i, e, s, bd) {
            if (typeof Chart === 'undefined') return;
            const ctx1 = document.getElementById('expenseChart'); const ctx2 = document.getElementById('flowChart');
            if (!ctx1 || !ctx2 || state.mode === 'edit') return;
            document.getElementById('center-total').innerText = 'S/ ' + formatMoney(e);
            
            const gradient = (ctx, c1, c2) => { const g = ctx.createLinearGradient(0, 0, 0, 300); g.addColorStop(0, c1); g.addColorStop(1, c2); return g; };
            const colors = { inc: ['#34d399', '#059669'], exp: ['#fb7185', '#be123c'], sav: ['#60a5fa', '#2563eb'], bd: [['#a78bfa','#7c3aed'], ['#fbbf24','#d97706'], ['#22d3ee','#0891b2'], ['#f472b6','#db2777'], ['#818cf8','#4f46e5']] };

            if (chart1) chart1.destroy();
            chart1 = new Chart(ctx1, {
                type: 'doughnut',
                data: { labels: Object.keys(bd), datasets: [{ data: Object.values(bd), backgroundColor: Object.keys(bd).map((_, i) => { const c = colors.bd[i % colors.bd.length]; return gradient(ctx1.getContext('2d'), c[0], c[1]); }), borderWidth: 0, borderRadius: 20, spacing: 5, hoverOffset: 10 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '88%', layout: { padding: 30 }, // PADDING AUMENTADO
                animation: { animateScale: true, animateRotate: true, duration: 1200, easing: 'easeOutQuart' }, plugins: { legend: { display: false }, tooltip: { backgroundColor: '#1e293b', bodyFont: { family: 'Inter' }, padding: 12, cornerRadius: 10 } } }
            });

            if (chart2) chart2.destroy();
            const ctx2d = ctx2.getContext('2d');
            chart2 = new Chart(ctx2, {
                type: 'bar',
                data: { labels: ['Ingresos', 'Gastos', 'Ahorro'], datasets: [{ data: [i, e, s], backgroundColor: [gradient(ctx2d, colors.inc[0], colors.inc[1]), gradient(ctx2d, colors.exp[0], colors.exp[1]), gradient(ctx2d, colors.sav[0], colors.sav[1])], borderRadius: 8, barPercentage: 0.45 }] },
                options: { responsive: true, maintainAspectRatio: false, animation: { duration: 1000, easing: 'easeOutQuart', delay: c => c.dataIndex * 150 }, plugins: { legend: { display: false }, tooltip: { backgroundColor: '#1e293b', padding: 12, cornerRadius: 8 } }, scales: { x: { grid: { display: false }, border: { display: false } }, y: { border: { display: false }, grid: { color: '#f1f5f9' }, ticks: { font: { size: 10 }, callback: v => 'S/ ' + v } } } }
            });
        }

        // --- LÓGICA ---
        function calcKPIs() {
            let i=0,e=0,s=0,bd={};
            state.structure.forEach(sec => {
                let sum=0; sec.items.forEach((_,idx) => sum+=(state.data[`${state.currentMonth}-${sec.id}-${idx}`]||0));
                if(sec.type==='income')i+=sum; else if(sec.type==='savings')s+=sum; else {e+=sum; if(sum>0)bd[sec.title]=sum;}
            });
            ['balance','income','expenses','savings'].forEach(k=>document.getElementById('kpi-'+k).innerText='S/ '+formatMoney(k==='balance'?i-e-s:k==='income'?i:k==='expenses'?e:s));
            document.getElementById('kpi-rate').innerText = i>0?((s/i)*100).toFixed(0)+'%':'0%';
            renderCharts(i,e,s,bd);
        }
        function updVal(k,v) { const n=parseFloat(v); if(isNaN(n))delete state.data[k]; else state.data[k]=n; save(); calcKPIs(); }
        function updStr(act,sIdx,iIdx,v) {
            const s=state.structure; if(act==='renameSec')s[sIdx].title=v; if(act==='changeType')s[sIdx].type=v; if(act==='delSec'&&confirm('¿Borrar?'))s.splice(sIdx,1);
            if(act==='addSec'){const n=prompt('Nombre:');if(n)s.push({id:'s'+Date.now(),title:n,type:'expense',items:['Item']});}
            if(act==='renameItem')s[sIdx].items[iIdx]=v; if(act==='delItem')s[sIdx].items.splice(iIdx,1); if(act==='addItem')s[sIdx].items.push('Nuevo');
            save(); renderDashboard();
        }
        function openCloneModal() {
            document.getElementById('src-month-name').innerText = MONTHS[state.currentMonth];
            const sel=document.getElementById('target-month-select'); sel.innerHTML='';
            MONTHS.forEach((m,i)=>{if(i!==state.currentMonth){const o=document.createElement('option');o.value=i;o.innerText=m;if(i===state.currentMonth+1)o.selected=true;sel.appendChild(o);}});
            document.getElementById('main-backdrop').classList.add('open'); document.getElementById('clone-modal').classList.add('open'); closeMenu();
        }
        function closeModal() { document.getElementById('main-backdrop').classList.remove('open'); document.getElementById('clone-modal').classList.remove('open'); }
        function executeClone() {
            const dest=parseInt(document.getElementById('target-month-select').value);
            const sp=`${state.currentMonth}-`, dp=`${dest}-`;
            Object.keys(state.data).forEach(k=>{if(k.startsWith(dp))delete state.data[k];});
            Object.keys(state.data).forEach(k=>{if(k.startsWith(sp))state.data[dp+k.substring(sp.length)]=state.data[k];});
            state.currentMonth=dest; save(); renderMenu(); renderDashboard(); closeModal(); showToast(`Copiado a ${MONTHS[dest]}`);
        }
        function showToast(m) { const t=document.getElementById('toast'); document.getElementById('toast-msg').innerText=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),3000); }
        function save() { localStorage.setItem('finanzas_V15', JSON.stringify({structure:state.structure,data:state.data})); }
        function setMode(m) { state.mode=m; const v=document.getElementById('btn-view'),e=document.getElementById('btn-edit'),c=document.getElementById('charts-container'); if(m==='view'){v.className="px-4 py-2 text-xs font-bold rounded-lg shadow-sm bg-white text-slate-800 flex items-center gap-2";e.className="px-4 py-2 text-xs font-bold rounded-lg text-slate-500 flex items-center gap-2";if(c)c.style.display='grid';}else{e.className="px-4 py-2 text-xs font-bold rounded-lg shadow-sm bg-white text-brand-600 ring-1 ring-brand-200 flex items-center gap-2";v.className="px-4 py-2 text-xs font-bold rounded-lg text-slate-500 flex items-center gap-2";if(c)c.style.display='none';} renderDashboard(); }
        function formatMoney(n) { return n.toLocaleString('es-PE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
        function exportData() { const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify({structure:state.structure,data:state.data})); a.download="Backup_V15.json"; a.click(); }
        function importData(inp) { const r=new FileReader(); r.onload=e=>{ try{const j=JSON.parse(e.target.result); state.structure=j.structure; state.data=j.data; save(); location.reload();}catch(x){alert('Error');}}; r.readAsText(inp.files[0]); }
        function resetAll() { if(confirm('¿Reiniciar?')) { localStorage.removeItem('finanzas_V15'); location.reload(); }}

        init();
    </script>
</body>
</html>
